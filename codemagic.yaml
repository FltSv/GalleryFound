scripts:
  - &get_flutter_packages
    name: Get Flutter packages
    working_directory: mobile
    script: |
      flutter packages pub get

definitions:
  workflow_trigger: &workflow_trigger
    triggering:
      events:
        - push
        - pull_request
      branch_patterns:
        - pattern: main
        - pattern: master
        - pattern: develop
    when:
      changeset:
        includes:
          - "mobile/"

  env_versions: &env_versions
    flutter: stable
    xcode: latest
    cocoapods: default

  cache: &cache
    cache_paths:
      - $FLUTTER_ROOT/.pub-cache
      - $HOME/.gradle/caches
      - $HOME/Library/Caches/CocoaPods

  publishing_email: &publishing_email
    email:
      recipients:
        - support@gallery-found.jp
      notify:
        success: false
        failure: true

workflows:
  android-workflow:
    name: Android Workflow
    <<: *workflow_trigger
    instance_type: mac_mini_m1
    max_build_duration: 20
    environment:
      <<: *env_versions
      android_signing:
        - keystore_reference
      groups:
        - google_credentials
      vars:
        GOOGLE_PLAY_TRACK: internal
    cache:
      <<: *cache
    scripts:
      - name: Set up local.properties
        working_directory: mobile
        script: |
          echo "flutter.sdk=$HOME/programs/flutter" > "$CM_BUILD_DIR/mobile/android/local.properties"
      - *get_flutter_packages
      - name: Build AAB with Flutter
        working_directory: mobile
        script: |
          flutter build appbundle --release \
            --build-number=$PROJECT_BUILD_NUMBER \
    artifacts:
      - mobile/build/**/outputs/**/*.aab
      - mobile/build/**/outputs/**/mapping.txt
      - mobile/flutter_drive.log
    publishing:
      <<: *publishing_email
      google_play:
        credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
        track: $GOOGLE_PLAY_TRACK
        submit_as_draft: true

  ios-workflow:
    name: iOS Workflow
    <<: *workflow_trigger
    instance_type: mac_mini_m1
    max_build_duration: 20
    integrations:
      app_store_connect: GalleryFound Codemagic

    environment:
      <<: *env_versions
      ios_signing:
        certificates:
          - galleryfound_certificate
        provisioning_profiles:
          - galleryfound_profile
      groups:
        - appstore_credentials
        - git_credentials

    cache:
      <<: *cache

    scripts:
      # ÁΩ≤ÂêçË®≠ÂÆö
      - name: Set up code signing settings on Xcode project
        working_directory: mobile/ios
        script: |
          xcode-project use-profiles

      # ‰æùÂ≠òÂèñÂæó
      - *get_flutter_packages

      # Pods „Ç§„É≥„Çπ„Éà„Éº„É´ÔºàÂ§±ÊïóÊôÇ„Å´ clean ‚Üí repo update ‚Üí ÂÜç„Ç§„É≥„Çπ„Éà„Éº„É´Ôºâ
      - name: Install pods (auto clean & repo update when needed)
        working_directory: mobile/ios
        script: |
          set -e

          echo "‚ñ∂Ô∏é 1st try: pod install"
          if pod install; then
            echo "‚úÖ Pods installed successfully on first try."
          else
            echo "‚ö†Ô∏è  Pod install failed. Cleaning & updating specs ..."

            # flutter clean („Éó„É≠„Ç∏„Çß„ÇØ„Éà„É´„Éº„Éà„Åß)
            pushd ..
            flutter clean
            flutter pub get
            popd

            # PodsÔºèPodfile.lock „ÇíÂâäÈô§„Åó„Å¶ÂÜçÊßãÁØâ
            rm -rf Pods Podfile.lock

            # CocoaPods specs Êõ¥Êñ∞
            pod repo update

            echo "‚ñ∂Ô∏é 2nd try: pod install after clean & repo update"
            pod install

            # repo update „ÅåËµ∞„Å£„ÅüË®ºÊòé„Éï„Ç°„Ç§„É´„ÇíÊÆã„Åô
            touch /tmp/pod_repo_updated
          fi

      # Podfile / Podfile.lock „ÅåÂ§âÂåñ„Åó„Å¶„ÅÑ„Åü„ÇâËá™Âãï„Ç≥„Éü„ÉÉ„Éà & Push
      - name: Commit and push Podfile changes if repo was updated
        working_directory: mobile/ios
        script: |
          set -e
          # repo update „ÅåË°å„Çè„Çå„Åü„Éì„É´„Éâ„ÅÆ„ÅøÂÆüÊñΩ
          if [ -f /tmp/pod_repo_updated ]; then
            echo "üîÑ  Checking for Podfile changes‚Ä¶"
            git diff --quiet Podfile Podfile.lock && {
              echo "‚ÑπÔ∏è  No changes detected, skipping git push."
              exit 0
            }

            # Git user ÊÉÖÂ†±Ë®≠ÂÆö
            git config --global user.name  "Codemagic Bot"
            git config --global user.email "codemagic-bot@gallery-found.jp"

            # ÂèñÂæó„Åó„Å¶„ÅÑ„Çã clone URL „Çí PAT ‰ªò„Åç„Å´ÁΩÆ„ÅçÊèõ„Åà
            GIT_URL=$(git config --get remote.origin.url)
            # https://github.com/owner/repo.git ‚Üí https://$TOKEN@github.com/owner/repo.git
            PAT_URL="${GIT_URL/https:\/\/github.com/https:\/\/${GIT_PUSH_TOKEN}@github.com}"
            git remote set-url origin "$PAT_URL"

            # Êñ∞Ë¶è„Éñ„É©„É≥„ÉÅÂêç„ÇíÁµÑ„ÅøÁ´ã„Å¶Ôºà‰æã: auto/pod-update-<BUILD_ID>Ôºâ
            BRANCH_NAME="auto/pod-update-${CM_BUILD_ID}"
            git checkout -b "$BRANCH_NAME"

            # Â§âÊõ¥„Çí„Ç≥„Éü„ÉÉ„Éà
            git add Podfile Podfile.lock
            git commit -m "chore(pods): Update specs via Codemagic build ${CM_BUILD_ID}"

            # Push
            git push -u origin "$BRANCH_NAME"

            echo "‚úÖ  Pushed Podfile changes to branch ${BRANCH_NAME}"
          else
            echo "‚ÑπÔ∏è  pod repo update was not executed; nothing to commit."
          fi

      # IPA „Éì„É´„Éâ
      - name: Flutter build ipa
        working_directory: mobile
        script: |
          flutter build ipa --release \
            --build-number=$PROJECT_BUILD_NUMBER \
            --export-options-plist=/Users/builder/export_options.plist
    artifacts:
      - mobile/build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - mobile/flutter_drive.log
    publishing:
      <<: *publishing_email
      app_store_connect:
        auth: integration
        submit_to_testflight: true
